# [読書]サーバレスシングルページアプリケーション
`#spa` `#JavaScript` `#OReilly` `#tdd` `#しがないラジオ`

## :closed_book: 読んだ本
|||
|:--|:-:|
|[サーバーレスシングルページアプリケーション<br/>――S3、AWS Lambda、API Gateway、DynamoDB、Cognitoで構築するスケーラブルなWebサービス ](https://www.oreilly.co.jp/books/9784873118062/)| ![](https://www.oreilly.co.jp/books/images/picture978-4-87311-806-2.gif)|


## :muscle: モチベーション
* サーバサイド(ありきで開発してきた)エンジニアだったので、「サーバレス」ということがどういうことなのか知りたかった。
* 個人ではAWSは触ったことがなかったので、触れておきたかった。
* [しがないラジオ ep.19](https://shiganai.org/ep/ep19-spa) で [@zuckey_17](https://twitter.com/search?q=%40zuckey_17&src=typd&lang=ja) さんがおすすめしていて、ピンときたのが一番のきっかけ。
* AWSは先に料金体系を学ばないとどこでお金がかかるのかわからなくて着手しにくいが、ちょっとAWSのことをしらべても料金体系が決してわかりやすい印象がなく、まずは手っ取り早く触りたかった。
* しがないラジオで聴いた感触で、「本のボリュームが軽く、本のとおりに写経ですすめていけば無料でセキュリティやスケールアップのことを含めてスタディできる」というのが好印象だったので、やってみた。
* チュートリアルが終わっても、セキュリティやスケールアップの観点がないと、「とはいえ、現実問題案件としてつかえるの？:unamused:」ということになりがちなので、それが書かれている良書だと思ってスタディすることにした。

## :clock1: かかった時間など
- 期間
2021/6/2 〜 2021/8/16
- トータル時間
37 hくらい。
途中以下に記載するところでだいぶハマったので、それがなければさらっと終われるはず
- やりかた
  - githubに写経用のリポジトリをつくって、各項理解したことをREAME.mdにメモしながら
  - チュートリアル用のリポジトリは、[Forkしたリポジトリ](https://github.com/ngwork0301/learnjs) をサブモジュールにしてすすめた。[^1]。
[^1]: スタディしたメモ等を残した親リポジトリは、書籍側の著作権侵害に抵触する可能性があるため非公開

## :curry: 完成したもの
[http://learnjs.ngwork0301.com.s3-website-us-east-1.amazonaws.com/](http://learnjs.ngwork0301.com.s3-website-us-east-1.amazonaws.com/)
* 書籍の写経のとおりつくったもの。JavaScriptのスタディを想定して、コードをフォームに入力して、答え合わせをするアプリ
* Google認証すれば、解答を保存できる機能があるが、本当のWebサービスではないので、現状一部の指定アカウントに限定してある。

## :smile: ざっくりと理解したこと
* まずハリボテのWebページをAmazon S3にいれてしまえば、それだけでサービスができあがる。さきにデプロイしてしまって、肉付けして開発するのがモダンな開発手法。今回は、著者が用意したAWS SDK/CLIをつかった簡単なツール(sspa)ですぐにデプロイした。
* ルーティングもすべてJS内で書ける。つまり最初のリクエストでプログラムの動作のほとんどをブラウザにロードさせる。
* 一部のサーバサイドの処理が必要な部分ももちろんあるが、従来のようなサーバサイドのプログラムを用意する必要はない。
  * 認証処理は、この例ではAWS CognitoからGoogle認証させる方法でおこなった。クライアントサイドからの呼び出しと設定だけでセキュアに使える
  * DB関連の処理は、DynamoDBとAWSの機能をつかって、こちらもクライアントサイドからのクエリ実行と設定だけでセキュアに使える
  * Lambdaをつかって、フロントではできない処理はマイクロサービスとして呼び出せる。たとえば今回の例では統計情報を集める処理で使用した。
* セキュリティの観点では、むしろ自前でサーバプログラムをつくらないでことでAWSに守ってもらう。ただしセキュリティ対策は従来どおり必要なので、各観点でAWSを使う場合にどう対策する/してあるのか調べて必要な部分を適用した。
* AWS CloudWatchでログをとって、統計情報(書籍ではシェル芸でとった)をみて、スケールアップの有無をチェック。料金体系とのバランスで各制限を変更。とくに一番最初にひっかかりそうなのはDynamoDB周りの読み書きのスレッショルド。

## :joy: ハマったところ
* Coginto/Google認証がなかなかうまくいかなかった。

* AWS API GatewayとつかったLambda関数の呼び出しで何度やってもコケる。



## :tada: 感想
* 簡単にクラウドベースのWebアプリがつくれたのはよかった。つらいAWSの料金体系とかセキュリティとかを気にしないでこれができるのはやはりうれしい。
* SPAはいわゆるPoC(Proof of Concept)のような形でソフトウェアの試作を素早く作成するのに向いている印象。ある程度市場の手応えをえた段階でも、AWSの設定でスケールアップもできるので、しばらくはつかってもらえるレベルのものはつくれる印象。前に会社でソフトウェアの試作大会のようなことをする機会があったが、そのときに知りたかった感。
* とはいえ、上記でめっちゃハマってたので、自分には初回では爆速では作れなかった。２回、３回目とつくっていけば、開発速度はかなり上がるはず。
* 本書も基本TDDで進められている。[テスト駆動開発](2021/test-driven-development-study) の読書後のスタディだったので、テスト駆動開発自体の理解をさらに深めることができたのはよかった。たとえばEtoEのテストばかり書かずに細かい粒度で網羅的に書くことの重要性＝FIREなテストスイートなど。
* ハマったときはなかなか進まずツラかった。自分がこれまでやってきた開発のようにサーバサイドのログはとれず、ブラウザに帰ってきたレスポンスで調査を始める必要があり、デバッグのコツがつかめなかった。しかもAWS用語が多すぎる。スタディに時間がかかって、AWS固有のノウハウはスタディのモチベーションがあがらない部分も少なからずあった。

### :pensive: よくなかったところ(本を選ぶ上での反省点)
* 書籍が古いので、内容もすこし古い。古すぎて差し支えるということはなかったが、とくにAWS API Gatewayの使い方などはだいぶ差が出ていた。もう他にこの時期に読み進めているひと(Forkしている人)は今はいない感があった。
* typoのプルリクを出したけど、著者のBen Radyさんももうこのリポジトリをメンテンスしていないのか、マージされず。初めてのプルリクなのでやり方がよくなかったか？簡単すぎる内容なのでissueを切っていないのがよくなかった？
* jQueryである。サーバレスシングルページアプリケーションを学ぶのであれば、モダンなフレームワークをつかっているほうがよさそう。「りあクト」でFirebase + React.jsのほうを読めばよかった感がある。
* とはいえ、自分にはjQueryに多少なりとも親しみがあったのと、EC2以外のAWSの感触が学べたのでこれはこれでよかった。


## :telescope: 今後の展望など
* これを中心に、社内の試作・提案、個人開発などでつかってみて、試作をサクッとつくれる基盤を整えることができたらよい。
* 世の中のどのくらいのSaasがSPAになっているのか気になるので、調査してみたい。Wappalyzerである程度のことはわかりそう。
* JSフレームワークも仕事でつかっていないので、ちゃんとはスタディしていない。Vue.jsを少しみたくらい。最近復権しているReact.jsをちゃんと学んでみるか。


